id: sgRNA_library_Design
name: 'Step I: SgRNA Library Design'
version: 1.0
description: "sgRNA Library Design: A Pipeline for Designing Libraries for CRISPR Base Editing Mutagenesis Screens"
author: Vincent Chapdelaine
workflow:

  steps:

    - name : Running CRISPR-BEdiscovered
      type : nextflow
      script : main.nf
      params:
        project: "${CLOUDGENE_JOB_NAME}"
        Genome_Json: "${genomic_dataset.database_url}"
        Cas_Variant_Json: "${cas_dataset.database_url}"
        Target_genes : "${Target_genes}"

      groups :
        - id : "Validation"
          label : "Validate Inputs"
        - id : "Crispr_Positive_library_prep"
          label : "Positive Library Preparation"
        - id : "Crispr_Negative_library_prep"
          label : 'Negative Library Preparation'
        - id : "Crispr_Target_library_prep"
          label : 'Target Library Preparation'
        - id : "Finalization"
          label : 'Combination and Report'
      processes:
        - process: "Validate"
          view: status
          label: 'Validate Inputs and Fetch Queried Regions'
          group: 'Validation'
        - process: "Crispr_Positive_library_prep:CRISPRverse"
          view: progressbar
          label: "Running CRISPRverse"
          group: "Crispr_Positive_library_prep"
        - process: "Crispr_Negative_library_prep:CRISPRverse"
          view: progressbar
          label: "Running CRISPRverse"
          group: "Crispr_Negative_library_prep"
        - process: "Crispr_Target_library_prep:CRISPRverse"
          view: progressbar
          label: "Running CRISPRverse"
          group: "Crispr_Target_library_prep"
        - process: "Crispr_Positive_library_prep:split_bed"
          view: label
          label: "Segmenting genomic regions for downstream analysis"
          group: "Crispr_Positive_library_prep"
        - process: "Crispr_Negative_library_prep:split_bed"
          view: label
          label: "Segmenting genomic regions for downstream analysis"
          group: "Crispr_Negative_library_prep"
        - process: "Crispr_Target_library_prep:split_bed"
          view: label
          label: "Segmenting genomic regions for downstream analysis"
          group: "Crispr_Target_library_prep"
        - process: "Crispr_Positive_library_prep:combine_failed"
          view: status
          label: "Running CRISPRverse"
          group: "Crispr_Positive_library_prep"
        - process: "Crispr_Negative_library_prep:combine_failed"
          view: status
          label: "Running CRISPRverse"
          group: "Crispr_Negative_library_prep"
        - process: "Crispr_Target_library_prep:combine_failed"
          view: status
          label: "Running CRISPRverse"
          group: "Crispr_Target_library_prep"
        - process: "Crispr_Positive_library_prep:OnTarget"
          view: progressbar
          label: "Calculating on-target efficiency"
          group: "Crispr_Positive_library_prep"
        - process: "Crispr_Negative_library_prep:OnTarget"
          view: progressbar
          label: "Calculating on-target efficiency"
          group: "Crispr_Negative_library_prep"
        - process: "Crispr_Target_library_prep:OnTarget"
          view: progressbar
          label: "Calculating on-target efficiency"
          group: "Crispr_Target_library_prep"
        - process: "Crispr_Positive_library_prep:OffTarget"
          view: progressbar
          label: "Filtering Based on Off-Targets"
          group: "Crispr_Positive_library_prep"
        - process: "Crispr_Negative_library_prep:OffTarget"
          view: progressbar
          label: "Filtering Based on Off-Targets"
          group: "Crispr_Negative_library_prep"
        - process: "Crispr_Target_library_prep:OffTarget"
          view: progressbar
          label: "Filtering Based on Off-Targets"
          group: "Crispr_Target_library_prep"
        - process: "Crispr_Positive_library_prep:Basic_Annotation"
          view: progressbar
          label: "Predicting Mutations"
          group: "Crispr_Positive_library_prep"
        - process: "Crispr_Negative_library_prep:Basic_Annotation"
          view: progressbar
          label: "Predicting Mutations"
          group: "Crispr_Negative_library_prep"
        - process: "Crispr_Target_library_prep:Basic_Annotation"
          view: progressbar
          label: "Predicting Mutations"
          group: "Crispr_Target_library_prep"
        - process: "Crispr_Positive_library_prep:combine_general"
          view: status
          label: "Predicting Mutations"
          group: "Crispr_Positive_library_prep"
        - process: "Crispr_Negative_library_prep:combine_general"
          view: status
          label: "Predicting Mutations"
          group: "Crispr_Negative_library_prep"
        - process: "Crispr_Target_library_prep:combine_general"
          view: status
          label: "Predicting Mutations"
          group: "Crispr_Target_library_prep"
        - process: "Crispr_Positive_library_prep:combine_vcfs"
          view: status
          label: "Predicting Mutations"
          group: "Crispr_Positive_library_prep"
        - process: "Crispr_Negative_library_prep:combine_vcfs"
          view: status
          label: "Predicting Mutations"
          group: "Crispr_Negative_library_prep"
        - process: "Crispr_Target_library_prep:combine_vcfs"
          view: status
          label: "Predicting Mutations"
          group: "Crispr_Target_library_prep"
        - process: "Crispr_Positive_library_prep:annotate"
          view: progressbar
          label: "Annotate Predicted Mutations"
          group: "Crispr_Positive_library_prep"
        - process: "Crispr_Negative_library_prep:annotate"
          view: progressbar
          label: "Annotate Predicted Mutations"
          group: "Crispr_Negative_library_prep"
        - process: "Crispr_Target_library_prep:annotate"
          view: progressbar
          label: "Annotate Predicted Mutations"
          group: "Crispr_Target_library_prep"
        - process: "Crispr_Positive_library_prep:annotate_tar"
          view: progressbar
          label: "Annotate Predicted Mutations"
          group: "Crispr_Positive_library_prep"
        - process: "Crispr_Negative_library_prep:annotate_tar"
          view: progressbar
          label: "Annotate Predicted Mutations"
          group: "Crispr_Negative_library_prep"
        - process: "Crispr_Target_library_prep:annotate_tar"
          view: progressbar
          label: "Annotate Predicted Mutations"
          group: "Crispr_Target_library_prep"
        - process: "Crispr_Positive_library_prep:combine_annotations"
          view: status
          label: "Annotate Predicted Mutations"
          group: "Crispr_Positive_library_prep"
        - process: "Crispr_Negative_library_prep:combine_annotations"
          view: status
          label: "Annotate Predicted Mutations"
          group: "Crispr_Negative_library_prep"
        - process: "Crispr_Target_library_prep:combine_annotations"
          view: status
          label: "Annotate Predicted Mutations"
          group: "Crispr_Target_library_prep"
        - process: "Finalization:combine_csv"
          view: label
          label: "Concatenate Libraries"
          group: "Finalization"
        - process: "Finalization:combine_vep"
          view: label
          label: "Concatenate Annotations"
          group: "Finalization"
        - process: "Finalization:report"
          view: label
          label: "Preparation Report"
          group: "Finalization"
        - process: "Crispr_Negative_library_prep:to_excel"
          view: label
          label: "Finalizing Output"
          group: "Crispr_Negative_library_prep"
        - process: "Crispr_Target_library_prep:to_excel"
          view: label
          label: "Finalizing Output"
          group: "Crispr_Target_library_prep"
        - process: "Crispr_Positive_library_prep:to_excel"
          view: label
          label: "Finalizing Output"
          group: "Crispr_Positive_library_prep"



  inputs:

    - id : Target_genes
      description : List of genes of interest <br> (<a href="https://cerc-genomic-medicine.ca/exampleGeneOfInterest.txt" target="_blank">example</a>) <br> (<a href="https://cerc-genomic-medicine.ca/Manuals/CRISPR-BEasy/FAQ/#how-to-perform-complex-sgrna-design-query" target="_blank">example</a>)
      type: textarea
      required : true
      details: "A one-entry-per-line file; accepts gene names or genomic region (coded as custom:chr:start-end). Jobs are limited to 1.5 Mbp in total (with controls)."

    - id: genomic_dataset
      description : Genome Build <br> (<a href="https://cerc-genomic-medicine.ca/Manuals/CRISPR-BEasy/FAQ/#how-do-i-request-a-new-genome" target="_blank">Missing your genome ?</a>)
      type: dataset
      required : true
      category: genomic_database
      value : apps@GRCh38@114
      serialize: false

    - id : isoform
      description : "Isoform to select"
      required : true
      type : radio
      value : None
      values :
        MANE_Select: MANE
        Ensembl_canonical: Canonical
        None: All isoform
      details: "Isoform to select (if unspecified)"

    - id : Flanking
      description : 'Flanking regions (bp) :'
      required : false
      details : "Number [0-100]"
      type : number
      value : 30

    - id: myseparator
      type: separator

    - id : cas_dataset
      description : Cas variant <br> (<a href="https://cerc-genomic-medicine.ca/Manuals/CRISPR-BEasy/More_information/#cas-variant-available" target="_blank">Details</a>)
      required : true
      type : dataset
      category : cas_database
      value : apps@SpCas9@0.0
      serialize: false

    - id : Editors
      description : Editors (<a href="https://cerc-genomic-medicine.ca/Manuals/CRISPR-BEasy/More_information/#editors" target="_blank">Details</a>)
      required : true
      type : textarea
      details : 'Space-delimited description of editors. Columns: id, start window of activity, end window of activity, nucleotide modified, resulting nucleotide.'
      value : "FNLS 3 8 C T\nCDA-BE4 -1 9 C T\nABE8 4 8 A G"


    - id : GC
      description : GC mutation abstraction
      required : true
      type: checkbox
      value: true
      values:
        true: true
        false: false
      details : C mutation in GC patterns will not be mutated in annotations

    - id : CFD_Count
      description : 'Limit count of predicted off-targets alignement' 
      required : false
      type : number
      details : 'Accepted range: 0-10 ; blank for unfiltered'

    - id : CFD_Threshold
      description : Threshold score for off-targets (CDF score) <br>  (<a href="https://cerc-genomic-medicine.ca/Manuals/CRISPR-BEasy/More_information/#off-target-scores" target="_blank">Details</a>)
      required : false
      type : number
      details : Float number ]0-1]
      details : 'CFD scores are designed for SpCas9 (Doench et al, Nat Biotechnol, 2016). Check "details" for other Cas9 variants. Leave blank for unfiltered'
    

    - id: myseparator
      type: separator

    - id : Positive_genes 
      description : Positive control protein(s) or regions(s) (optional) <br> (<a href="https://cerc-genomic-medicine.ca/Manuals/CRISPR-BEasy/More_information/#positive-and-negative-controls" target="_blank">Details</a>)
      type: textarea
      details : 'A one-entry-per-line file; see gene of interest section'
      required : false

    - id: myseparator
      type: separator

    - id : Negative_genes
      description : Negative control protein(s) or region(s) (optional)  <br> (<a href="https://cerc-genomic-medicine.ca/Manuals/CRISPR-BEasy/More_information/#positive-and-negative-controls" target="_blank">Details</a>)
      details : 'A one-entry-per-line file; see gene of interest section'
      type: textarea
      required : false


  outputs:

    - id: Libraries
      description: Excel files containing libraries with annotations
      type: local_folder

    - id: Auxiliary_files
      description: 'Auxiliary files'
      type: local_folder

    - id: Report_output 
      description: 'Overview of guides'
      type: local_folder
